import fs from "fs";
import path from "path";

function to_csv_file(rows) {
  if (!rows.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = v => {
    if (v == null) return "";
    const s = String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
  };
  return [headers.join(","), ...rows.map(r => headers.map(h => esc(r[h])).join(","))].join("\n");
}

async function save_to_csv_file(all_rows, iterationIndex, headersWritten, FOLDER_NAME, FILE_NAME) {
  const DIR = "/Users/stevecalla/wrestling/data_tracker_wrestling";
  const CSV_FILE = path.join(DIR, FOLDER_NAME, FILE_NAME);

  fs.mkdirSync(path.join(DIR, FOLDER_NAME), { recursive: true });

  console.log(`üìù Saving to CSV file: ${CSV_FILE}`);

  // Skip empty batches until we get data
  if (!Array.isArray(all_rows) || all_rows.length === 0) {
    console.log(`‚ÑπÔ∏è Iteration ${iterationIndex}: no data, waiting for next batch...`);
    headersWritten = headersWritten;
    return headersWritten;
  }

  // Build CSV normally
  const csvFull = to_csv_file(all_rows);
  const lines = csvFull.split(/\r?\n/).filter(Boolean);
  const headerLine = lines.shift();  // first line
  const rowsOnly = lines.join("\n");

  // If we haven‚Äôt written headers yet, start fresh file
  if (!headersWritten) {
    fs.writeFileSync(CSV_FILE, headerLine + "\n" + rowsOnly + "\n", "utf8");
    console.log(`\n\x1b[32müßæ Created ${CSV_FILE} with headers + ${all_rows.length} rows\x1b[0m`); // green
    headersWritten = true;
    return headersWritten;
  } else {
    // Append only rows
    fs.appendFileSync(CSV_FILE, "\n" + rowsOnly + "\n", "utf8");
    console.log(`\n\x1b[33m‚ûï Appended ${all_rows.length} rows ‚Üí ${CSV_FILE}\x1b[0m`); // yellow
    headersWritten = true;
    return headersWritten;
  }

}

export { save_to_csv_file };